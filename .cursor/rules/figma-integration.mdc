---
description: Figma MCP連携ルール
globs: "**/*"
alwaysApply: true
---

# Figma MCP連携

## ⛔ 最重要ルール

```
絶対にFigmaの「ファイル全体」や「ページ全体」を一気に読み込まない
```

**理由:** トークン爆発、精度低下、コスト増大

## ✅ 正しいアプローチ

```
❌ NG: 「このFigmaファイル全体を見て」
❌ NG: 「このページ全体を読み込んで」

✅ OK: 「Node ID: xxx のデータを取得して」
✅ OK: 「このセクション（Node ID: yyy）を実装して」
```

## 📍 Node ID 取得方法

1. Figmaで対象フレームを選択
2. 右クリック → 「リンクをコピー」
3. URLの `node-id=XXX-XXX` がNode ID

---

## 🔄 実装フロー（2段階アプローチ）

### 概要

```
Figma MCP → JSON保存 → 品質チェック → HTML + SCSS → PHP
```

**直接PHPを生成しない理由:**
- 一度に処理する情報が多すぎる
- 中間確認（HTMLプレビュー）ができない
- トークン消費が大きい

**ポイント:** 全セクションをHTML化してから、まとめてPHP化する

### フロー詳細

```
【Phase 1】スタイルガイド → _variables.scss

【Phase 2】全セクションHTML化（セクションごとに繰り返し）
   1. MCPでデータ取得 → figma-data/[name].json 保存
   2. AIが品質チェック → 報告
      ├─【良い】→ MD整理
      └─【悪い】→ 数値抽出 + 画像保存
   3. SCSS作成 → wp-theme/assets/scss/sections/_[name].scss
   4. npm run build:css
   5. HTML作成 → static-preview/sections/[name].html
   
   → 全セクション完了後、ブラウザで全体確認

【Phase 3】全セクションPHP化（まとめて実行）
   → wp-theme/template-parts/section-[name].php

【Phase 4】ACF動的化
```

---

## ⚠️ データ品質の判断

### 良いデータ ✅

- Auto Layout使用（layoutMode あり）
- 意味のあるレイヤー名（header, nav, button等）
- 整理された構造

→ **MCPデータから構造+数値を使用**

### 悪いデータ ⚠️

- 絶対座標のみ（x, y だけ）
- 「Rectangle 1」「Group 2」など意味不明な名前
- DX→Figma変換など

→ **画像メイン + MCP数値のハイブリッド**

### AIの判断基準

MCPデータ取得後、以下をチェック：

1. `layoutMode` が存在するか（Auto Layout）
2. `name` プロパティが意味を持つか
3. 構造が入れ子で整理されているか

→ 判断結果をユーザーに報告し、アプローチを確認

---

## 📁 ファイル保存場所

| データ種別 | 保存先 |
|-----------|--------|
| MCPの生データ | `figma-data/[name].json` |
| 整理済みデータ | `figma-data/[name].md` |
| 数値のみ抽出 | `figma-data/[name]-values.md` |
| 参考画像 | `figma-data/images/[name].png` |
| HTMLプレビュー | `static-preview/sections/[name].html` |
| SCSS | `wp-theme/assets/scss/sections/_[name].scss` |
| PHP | `wp-theme/template-parts/section-[name].php` |

---

## 🖼️ 画像について

MCPは画像をダウンロードできない。

**対応方法:**
- コード内ではプレースホルダー使用（`https://placehold.co/`）
- 実際の画像はFigmaから手動書き出し
- 悪いFigmaの場合、レイアウト参考用に `figma-data/images/` に保存

---

## 📋 プロンプトテンプレート

詳細は `docs/PROMPTS.md` を参照。

主なプロンプト:
- Step 0: 品質チェック & データ保存
- Step 1a: MD整理（良いFigma）
- Step 1b: 数値抽出（悪いFigma）
- Step 2: SCSS作成
- Step 3: HTML作成
- Step 4: ブラウザ確認
- Step 5: PHP化
