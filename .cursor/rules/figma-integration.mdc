---
description: Figma MCP連携ルール
globs: "**/*"
alwaysApply: true
---

# Figma MCP連携ガイドライン

> Figma MCPを使ってデザインを実装する際のルールとプロンプトテンプレート

## 前提
- デザインは別のデザイナーさんが作成
- 自分はコーディング担当
- Figmaデザインは変更しない（参照のみ）
- **Figma Dev Mode + MCP** を活用

---

## ⛔ 最重要：全体渡しは絶対NG

```
🚨 警告：Figmaの「ファイル全体」や「ページ全体」を一気に読み込ませてはいけません
```

### なぜダメなのか？（3つの罠）

| 罠 | 説明 |
|----|------|
| **1. トークン爆発** | Figmaのデータは膨大。全体を渡すとCursorのコンテキスト上限に達し、最初の指示を忘れる |
| **2. 精度低下** | 情報量が多すぎると、AIは重要な情報を見落とし、適当なコードを書き始める（ハルシネーション） |
| **3. コスト・時間の無駄** | 処理に時間がかかり、API使用量も増大 |

### 正しいアプローチ

```
❌ NG: 「このFigmaファイル全体を見てコーディングして」
❌ NG: 「このページ全体を読み込んで」

✅ OK: 「このスタイルガイド（Node ID: xxx）から変数を抽出して」
✅ OK: 「このヘッダーセクション（Node ID: yyy）を実装して」
```

---

## ⚡ API使用量の最適化

### 基本方針：2段階アプローチ

```
【フェーズ1】脳を作る = スタイルガイドだけを渡す（最初に1回）
    ↓
【フェーズ2】手を作る = セクションごとに渡す（都度）
```

### フェーズ1：スタイルガイドだけを渡す

**目的**: サイト全体の「ルール（色、フォント、余白）」を理解させる

1. Figmaの「Style Guide」「Typography」「Colors」フレームのNode IDを取得
2. そこだけをMCPで読み込ませる
3. `_variables.scss` を生成させる

→ これで「全体把握」の代わりになる

### フェーズ2：セクションごとに渡す

**目的**: 高精度なHTML/CSSを書かせる

1. ヘッダー、フッター、メインビジュアル、Aboutセクション…と分ける
2. 各フレームのNode IDを指定して読み込ませる
3. Phase 1で作った変数を使ってコーディングさせる

---

## 📍 Node ID の取得方法

### 方法1: FigmaのURLから取得
```
https://www.figma.com/design/xxxxx/FileName?node-id=123-456
                                            ↑ これがNode ID
```

### 方法2: Figmaで「リンクをコピー」
1. 対象のフレーム/レイヤーを選択
2. 右クリック → 「リンクをコピー」
3. URLの `node-id` パラメータを確認

### Node ID指定が最強な理由
- ファイル検索より確実で高速
- 必要なデータだけを取得できる
- トークン消費を最小限に抑えられる

---

## ⚠️ Figma MCPの制約と対策

### 画像は手動書き出しが必要

```
🖼️ MCPは画像の「情報（URL、配置）」は取得できますが、
   jpg/pngファイルを自動ダウンロードする機能はありません。
```

**対策:**
- 画像アセットはFigmaから手動で書き出し
- `assets/images/` に配置
- AIには「画像はプレースホルダーで仮置き」と指示

### きれいなFigmaデータが前提

MCPはデータを正直に読み取ります。Figma上で：
- グループ化が適当
- Auto Layout未使用で手動配置

→ 生成されるHTML/CSSも汚くなる

**対策:**
- デザイナーにAuto Layout使用を依頼
- 構造が不明瞭な場合はAIに確認を促す

---

## 🪄 プロンプトテンプレート集

### フェーズ1: スタイルガイド読み込み（最初に1回だけ）

#### 1-1. SCSS変数の生成（最重要）
```markdown
@Figma
ツール `get_node` を使用して、Node ID: [スタイルガイドのID] のデータを取得してください。

このデータから以下を抽出し、`_variables.scss` を作成してください：

**抽出項目:**
- カラーパレット（$color-primary, $color-secondary, $color-text 等）
- フォントファミリー
- フォントサイズ（$font-size-base, $font-size-lg 等）
- 基本スペーシング（$spacing-sm, $spacing-md 等）

**命名規則:**
- 色: $color-{用途}
- フォント: $font-{プロパティ}-{サイズ}
- 余白: $spacing-{サイズ}

出力はコードのみでお願いします。
```

#### 1-2. ページ構成の確認（構造のみ）
```markdown
@Figma
このプロジェクトのファイル構造を解析してください。

⚠️ 重要: デザインの詳細（色、座標、スタイル）は一切不要です。
以下の「構造情報」だけをリストアップしてください：

1. 全ページの名称（Top, About, Serviceなど）
2. 各ページ内のセクション名
3. 共通コンポーネント（ヘッダー、フッター、ボタン等）の有無

出力は簡潔なリスト形式でお願いします。
```

---

### フェーズ2: セクション実装（繰り返し）

#### 2-1. ヘッダー/フッター実装
```markdown
@Figma
ツール `get_node` を使用して、Node ID: [ヘッダーのID] のデータを取得してください。

取得したAuto Layoutの構造とスタイル情報を元に、以下を実装してください：

**ファイル:**
1. HTML: `parts/header.html`（WordPressテンプレートパーツ）
2. SCSS: `assets/scss/sections/_header.scss`

**要件:**
- さきほど定義した `_variables.scss` の変数を必ず使用（ハードコード禁止）
- ロゴはトップページへのリンク
- ナビゲーションは `<!-- wp:navigation -->` を使用
- SP時はハンバーガーメニュー化
- BEM記法を厳守（.block__element--modifier）
- レスポンシブ対応（SP/PC）を含める
```

#### 2-2. 汎用セクション実装
```markdown
@Figma
ツール `get_node` を使用して、Node ID: [セクションのID] のデータを取得してください。

取得した情報を元に、以下を実装してください：

**ファイル:**
1. HTML: `patterns/[セクション名].html`（WordPressブロックパターン形式）
2. SCSS: `assets/scss/sections/_[セクション名].scss`

**要件:**
- `_variables.scss` の変数を使用（色、フォント、余白すべて）
- BEM記法を使用（.block__element--modifier）
- レスポンシブ対応（SP/PC）を含める
- 画像はプレースホルダー（`https://placehold.jp/WIDTHxHEIGHT.png`）を使用
- セマンティックなHTML構造（section, h2, ul/li 等）
```

---

### フェーズ3: 動的化（ACF連携）

#### 3-1. ACFフィールド設計
```markdown
この [セクション名] のデザインを見てください。

動的に変更すべき箇所を特定し、以下を出力してください：
1. ACFフィールドグループ設計（フィールド名、タイプ、用途）
2. PHPでの出力コード（get_field使用、エスケープ処理込み）

**要件:**
- フィールド名は英語スネークケース（hero_title, about_description 等）
- 出力時は必ず esc_html(), esc_url(), esc_attr() を使用
- 繰り返し要素は have_rows() を使用
- セキュリティを最優先
```

#### 3-2. ループ処理の実装
```markdown
この [セクション名] を動的に変更します。

**要件:**
1. テキスト・画像を ACF の get_field() に置き換え
2. 繰り返し要素は have_rows() または WP_Query を使用
3. ループ後は必ず wp_reset_postdata() を実行
4. 出力時は必ずエスケープ処理（esc_html, esc_url, esc_attr）

セキュリティを最優先してください。
```

---

### フェーズ4: 品質チェック

#### 4-1. コードレビュー
```markdown
今回作成したファイルについて、以下をチェックしてください：

チェック項目：
- [ ] BEM命名規則は正しいか？
- [ ] 色・フォントサイズのハードコードはないか？
- [ ] `_variables.scss` の変数が正しく使われているか？
- [ ] レスポンシブ対応は適切か？
- [ ] エスケープ処理は漏れていないか？
- [ ] 不要なIDセレクタは使われていないか？

問題がある場合は修正案を提示してください。
```

---

## 🔄 ワークフロー全体像

```
【Step 0】Node ID を準備
├── スタイルガイドのNode ID
├── 各セクションのNode ID
└── FigmaのURL or 「リンクをコピー」で取得

【Step 1】脳を作る（API取得: 1回）
├── スタイルガイドのNode IDだけを渡す
├── _variables.scss を生成
└── ※ページ全体は絶対に渡さない

【Step 2】構造を把握（API取得: 1回・軽量）
├── ページ構成だけを確認（詳細データは取得しない）
├── セクションリストをメモに記録
└── WordPress設計（CPT, テンプレート）を決定

【Step 3】セクション実装（API取得: セクションごと）
├── 各セクションのNode IDを指定
├── _variables.scss の変数を使ってコーディング
├── HTML + SCSS をセットで作成
├── 画像は手動書き出し or プレースホルダー
└── 次のセクションへ

【Step 4】動的化
├── ACFフィールド設計
├── PHP出力コード作成
└── ループ処理実装

【Step 5】品質チェック
├── AIによるコードレビュー
├── 人間による目視確認（AIは微細なズレが苦手）
└── レスポンシブテスト
```

---

## 📝 取得情報のキャッシュ（メモ）

最初にスタイルガイドから取得したら、以下をメモとして残す：

```markdown
## デザインメモ（変数定義の根拠）

### カラーパレット
- Primary: #3B82F6
- Secondary: #10B981
- Text: #1F2937
- Background: #FFFFFF

### フォント
- 見出し: Noto Sans JP / Bold / 32px（PC）, 24px（SP）
- 本文: Noto Sans JP / Regular / 16px / line-height: 1.75

### スペーシング
- セクション間: 80px（PC）, 48px（SP）
- 要素間: 24px

### セクション構成 & Node ID
1. Header - Node ID: 123-456
2. Hero - Node ID: 123-457
3. About - Node ID: 123-458
4. Service - Node ID: 123-459
5. News - Node ID: 123-460
6. Contact - Node ID: 123-461
7. Footer - Node ID: 123-462
```

---

## 実装優先順位

1. スタイルガイド読み込み → `_variables.scss` 生成
2. グローバルスタイル（theme.json + _base.scss）
3. ヘッダー/フッター（parts/）
4. 共通コンポーネント（components/）
5. セクション/パターン（patterns/）
6. 個別テンプレート（templates/）
7. 動的化（ACF連携）

---

## デザイナーへの確認が必要なケース

以下の場合は、実装前にユーザーに確認を促す：
- デザインに曖昧な部分がある
- レスポンシブ時の挙動が不明
- ホバー状態のデザインがない
- Auto Layoutが使われていない（構造が不明瞭）
- 実装上の都合でデザインの調整が必要
